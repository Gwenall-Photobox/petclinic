node {
    echo 'Pipeline'    
    stage 'Checkout'
    git "https://github.com/Gwenall-Photobox/petclinic.git"

    stage 'Build application war file'
    // Build petclinic in a Maven3+JDK8 Docker container
    docker.image('maven:3-jdk-8').inside('-v /.m2:/root/.m2') {
        sh 'mvn -B package -DskipTests'
    }

    stage 'Build application Docker image'
//    def appImg = docker.build("nicolas-deloof/petclinic")

    kubernetes.pod('buildpod').withImage('nicolas-deloof/petclinic').inside {
        def imageName = 'petclinic'
        def tag = 'latest'
        kubernetes.image().withName(imageName).build().fromPath(".")
//        kubernetes.image().withName(imageName).tag().inRepository('docker.io/fabric8/'+imageName).force().withTag(tag)
//        kubernetes.image().withName('docker.io/fabric8/'+imageName).push().withTag(tag).toRegistry()
    }
    
    
//    stage 'Run app on Kubernetes'
//    withKubernetes( serverUrl: 'https://52.50.54.175', credentialsId: 'admin' ) {
//          sh 'kubectl run petclinic --image=gcr.io/nicolas-deloof/petclinic --port=8080'
//    }

    // ... Do some tests on deployed application web UI

}
